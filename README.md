# ğŸ“Š ãƒ‡ãƒ¼ã‚¿åˆ†æãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼šåŠ´åƒãƒ»çµ¦ä¸ã¨å‡ºå›½è€…æ•°ã®å‚¾å‘åˆ†æ

## ğŸ“Œ æ¦‚è¦

æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ã€Google Cloud ä¸Šã«ãŠã‘ã‚‹**è‡ªå‹•åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿åˆ†æãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³**ã®æ§‹ç¯‰ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚  
Cloud Storage ä¸Šã® CSV ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èµ·ç‚¹ã«ã€Cloud Composer ã«ã‚ˆã‚‹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«åˆ¶å¾¡ã€Dataflow ã«ã‚ˆã‚‹ ETL å‡¦ç†ã€  
BigQuery ã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ãƒˆç”Ÿæˆã€Workflows ã«ã‚ˆã‚‹ Slack é€šçŸ¥ã‚’é€£æºã•ã›ãŸãƒ•ãƒ­ãƒ¼ã‚’æ§‹æˆã—ã¦ã„ã¾ã™ã€‚

> ãƒ‡ãƒ¼ã‚¿åˆ†æã®ä¸€é€£ã®æµã‚Œã‚’ GCP ä¸Šã§å®Œçµã§ãã‚‹æ§‹æˆã‚’å­¦ç¿’ãƒ»å†ç¾ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚

## ğŸ” åˆ†æç›®çš„

åŠ´åƒè€…äººå£ï¼ˆæ­£è¦ãƒ»éæ­£è¦ï¼‰ã¨ç¾é‡‘çµ¦ä¸ã€å‡ºå›½è€…æ•°ã®é–¢ä¿‚æ€§ã‚’å¯è¦–åŒ–ãƒ»åˆ†æã—ã€ç¤¾ä¼šå‹•å‘ã‚’æŠŠæ¡ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¾ã™ã€‚

## ğŸ“¥ ä½¿ç”¨ãƒ‡ãƒ¼ã‚¿ï¼ˆæ”¿åºœçµ±è¨ˆã®ç·åˆçª“å£ e-Stat ã‚ˆã‚Šå–å¾—ï¼‰

ä»¥ä¸‹ã®çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’æ´»ç”¨ã—ã¾ã™ï¼š

- **å‡ºå›½è€…æ•°ï¼ˆç·æ•°ï¼‰**  
  https://dashboard.e-stat.go.jp/timeSeriesResult?indicatorCode=0204040001000010010

- **æ­£è¦ã®è·å“¡ãƒ»å¾“æ¥­å“¡ï¼ˆç”·å¥³è¨ˆï¼‰**  
  https://dashboard.e-stat.go.jp/timeSeriesResult?indicatorCode=0303010000000010010

- **éæ­£è¦ã®è·å“¡ãƒ»å¾“æ¥­å“¡ï¼ˆç”·å¥³è¨ˆï¼‰**  
  https://dashboard.e-stat.go.jp/timeSeriesResult?indicatorCode=0303020000000010010

- **ç¾é‡‘çµ¦ä¸ç·é¡**  
  https://dashboard.e-stat.go.jp/timeSeriesResult?indicatorCode=0302020000000010000

---

## ğŸ¯ ã“ã®æ§‹æˆã§å®Ÿç¾ã§ãã‚‹ã“ã¨

- GCP ä¸Šã§ãƒ‡ãƒ¼ã‚¿åˆ†æåŸºç›¤ï¼ˆETLã€œé›†è¨ˆã€œé€šçŸ¥ï¼‰ã‚’æ§‹ç¯‰
- Composer ã‚„ Dataflow ãªã©ã®ãƒãƒãƒ¼ã‚¸ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹é€£æºã‚’ä½“å¾—
- BigQuery ä¸Šã«è‡ªå‹•çš„ã«æ§‹ç¯‰ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ãƒˆã‚’ã‚‚ã¨ã«ã€Slack é€šçŸ¥ãªã©ã®é‹ç”¨é€£æºãŒå¯èƒ½

---

## ğŸ—º ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³

![ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³](img/arch.png)

---

## âœ… å‡¦ç†ã®æµã‚Œ

1. Cloud Storage ã« CSV ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ ¼ç´ã•ã‚Œã¦ã„ã‚‹çŠ¶æ…‹ã‚’å‰æã¨ã—ã¾ã™
2. Cloud Composer ã® DAG ã«ã‚ˆã‚Šæ¯æœ 9:00 ã«ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒèµ·å‹•
3. Dataflow ãŒèµ·å‹•ã—ã€Cloud Storage ä¸Šã® CSV ã‚’åŠ å·¥ã—ã¦ BigQuery ã«æ ¼ç´
4. BigQuery ä¸Šã§ãƒãƒ¼ãƒˆç”¨ã®ã‚¯ã‚¨ãƒªãŒè‡ªå‹•å®Ÿè¡Œã•ã‚Œã€é›†è¨ˆãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œæˆã•ã‚Œã‚‹
5. Workflows ã«ã‚ˆã‚Šã€ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†å¾Œã« Slack é€šçŸ¥ãŒé€ä¿¡ã•ã‚Œã€å¿…è¦ã«å¿œã˜ã¦ DL ãƒªãƒ³ã‚¯ã‚‚å…±æœ‰ã•ã‚Œã‚‹

---

## ğŸ–¥ ä½¿ç”¨ç’°å¢ƒ

| é …ç›®             | å†…å®¹                                 |
| ---------------- | ------------------------------------ |
| OS               | Ubuntuï¼ˆWSL2ï¼‰5.15.167.4             |
| Terraform        | v1.12.1ï¼ˆä»»æ„ï¼‰                      |
| Google Cloud SDK | 522.0.0                              |
| bq CLI           | 2.1.16                               |
| Python           | 3.10 ä»¥ä¸Šï¼ˆDAG/Dataflow ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼‰ |

---

## ğŸ“ ãƒ•ã‚§ãƒ¼ã‚ºæ§‹æˆï¼ˆèª¬æ˜é †ï¼‰

| ãƒ•ã‚§ãƒ¼ã‚º | èª¬æ˜                                                    |
| -------- | ------------------------------------------------------- |
| Phase 1  | Cloud Storageãƒ»BigQueryãƒ»Composerãƒ»Slack Webhook ã®æº–å‚™ |
| Phase 2  | Cloud Composer ã«ã‚ˆã‚‹å®šæœŸã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°è¨­å®š           |
| Phase 3  | Dataflow ã«ã‚ˆã‚‹ CSV ã® ETL å‡¦ç† â†’ BigQuery æ›¸ãè¾¼ã¿     |
| Phase 4  | BigQuery ä¸Šã§ã®ãƒãƒ¼ãƒˆç”Ÿæˆã‚¯ã‚¨ãƒªå®Ÿè¡Œ                     |
| Phase 5  | Workflows ã«ã‚ˆã‚‹ Slack é€šçŸ¥ã¨ãƒ¬ãƒãƒ¼ãƒˆ DL ãƒªãƒ³ã‚¯ã®é€ä¿¡   |

---

## ğŸ“Œ æˆæœç‰©ã®ä¾‹

- Slack é€šçŸ¥ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆï¼ˆWorkflows çµŒç”±ï¼‰
- BigQuery ä¸Šã«ç”Ÿæˆã•ã‚ŒãŸãƒãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«
- Composer DAG UI ä¸Šã§ã®ã‚¸ãƒ§ãƒ–å¯è¦–åŒ–
- ï¼ˆä»»æ„ï¼‰Cloud Storage ã¸å‡ºåŠ›ã•ã‚ŒãŸãƒ¬ãƒãƒ¼ãƒˆ CSV ãƒ•ã‚¡ã‚¤ãƒ«

---

## ğŸ›  ä½¿ç”¨æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

- **Cloud Composer**ï¼ˆAirflow ãƒ™ãƒ¼ã‚¹ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ï¼‰
- **Dataflow**ï¼ˆApache Beam ãƒ™ãƒ¼ã‚¹ã® ETL å‡¦ç†åŸºç›¤ï¼‰
- **BigQuery**ï¼ˆDWH & SQL åˆ†æï¼‰
- **Workflows**ï¼ˆãƒãƒãƒ¼ã‚¸ãƒ‰ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç®¡ç†ï¼‰
- **Slack Webhook**ï¼ˆé€šçŸ¥é€£æºï¼‰
- **Looker Studio**ï¼ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®å¯è¦–åŒ–ï¼‰

---

## ğŸ’¼ å®Ÿå‹™å¿œç”¨ãƒã‚¤ãƒ³ãƒˆ

- è¤‡æ•°ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‹ã‚‰ã®çµ±åˆãŠã‚ˆã³ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›ã‚’ Apache Beam ã«ã‚ˆã‚Šè‡ªå‹•åŒ–
- DAG ã®åˆ†å‰²ãƒ»ä¾å­˜é–¢ä¿‚å®šç¾©ã«ã‚ˆã‚Šã€æ®µéšçš„ã«å‡¦ç†ãƒ»é€šçŸ¥ãŒå¯èƒ½ãªæ§‹æˆã«è¨­è¨ˆ
- Slack é€šçŸ¥ã¨ Looker Studio ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰é€£æºã«ã‚ˆã‚Šã€éã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢å±¤ã¸ã®å…±æœ‰ã‚‚æƒ³å®š
- Terraform ã«ã‚ˆã‚Š GCP ãƒªã‚½ãƒ¼ã‚¹å…¨ä½“ã‚’ã‚³ãƒ¼ãƒ‰ã§ç®¡ç†ã€å†ç¾æ€§ã®ã‚ã‚‹ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰ã‚’å®Ÿç¾

---

## ğŸ§­ æƒ³å®šãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹

- å®šæœŸçš„ãªæ”¿åºœçµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®åé›†ãƒ»é›†è¨ˆãƒ»å…±æœ‰
- ç¤¾å†…å‘ã‘ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ãƒ¬ãƒãƒ¼ãƒˆã‚„æœˆæ¬¡å ±å‘Šç”¨ã®è‡ªå‹•åŒ–åŸºç›¤æ§‹ç¯‰
- ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å…¨ä½“ã®çµ±åˆç®¡ç†ã¨é€šçŸ¥ã«ã‚ˆã‚‹æ¥­å‹™åŠ¹ç‡åŒ–

---

## ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

<pre><code>
.
â”œâ”€â”€ README.md
â”œâ”€â”€ envs
â”‚   â””â”€â”€ dev
â”‚       â”œâ”€â”€ backend.tf
â”‚       â”œâ”€â”€ locals.tf (gitigore)
â”‚       â”œâ”€â”€ main.tf
â”‚       â”œâ”€â”€ outputs.tf
â”‚       â””â”€â”€ provider.tf
â”œâ”€â”€ data
â”‚   â”œâ”€â”€ nonregularemployee.zip
â”‚   â”œâ”€â”€ passengers.zip
â”‚   â”œâ”€â”€ regularemployee.zip
â”‚   â””â”€â”€ salary.zip
â”œâ”€â”€ img
â”‚   â””â”€â”€ arch.png
â”œâ”€â”€ modules
â”‚   â”œâ”€â”€ artifactregistry
â”‚   â”‚   â”œâ”€â”€ outputs.tf
â”‚   â”‚   â”œâ”€â”€ registry.tf
â”‚   â”‚   â””â”€â”€ variables.tf
â”‚   â”œâ”€â”€ bq
â”‚   â”‚   â”œâ”€â”€ dataset.tf
â”‚   â”‚   â”œâ”€â”€ outputs.tf
â”‚   â”‚   â””â”€â”€ variables.tf
â”‚   â”œâ”€â”€ composer
â”‚   â”‚   â”œâ”€â”€ etl.tf
â”‚   â”‚   â”œâ”€â”€ outputs.tf
â”‚   â”‚   â””â”€â”€ variables.tf
â”‚   â””â”€â”€ storage
â”‚       â”œâ”€â”€ outputs.tf
â”‚       â”œâ”€â”€ storage.tf
â”‚       â””â”€â”€ variables.tf
â””â”€â”€ src
    â”œâ”€â”€ composer
    â”‚   â””â”€â”€ etl_dataflow_pipeline.py
    â””â”€â”€ dataflow
        â”œâ”€â”€ Dockerfile
        â”œâ”€â”€ etl.py
        â”œâ”€â”€ metadata.json
        â””â”€â”€ requirements.txt
</code></pre>

---

## ğŸš€ ç’°å¢ƒæ§‹ç¯‰ã¨å®Ÿè¡Œæ‰‹é †

### å‰æ

- GCP ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒä½œæˆæ¸ˆã§ã‚ã‚‹ã“ã¨
- Cloud Composer, Dataflow API ãªã©ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ã“ã¨

### æ‰‹é †æ¦‚è¦

# â‘  Terraform ã«ã‚ˆã‚‹ãƒªã‚½ãƒ¼ã‚¹æ§‹ç¯‰

<pre><code>
cd modeules/envs/dev
terraform init
terraform apply
</code></pre>

# â‘¡ Artifical Registry ã¸ã® Image ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

<pre><code>
gcloud auth configure-docker asia-northeast1-docker.pkg.dev
docker build -t asia-northeast1-docker.pkg.dev/[ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ ID]/dev-karasuit-create-template/etl-image:v1 .
docker push asia-northeast1-docker.pkg.dev/[ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ ID]/dev-karasuit-create-template/etl-image:v1
</code></pre>

# â‘¢ Dataflow ç”¨ã® Template ã‚’ãƒ“ãƒ«ãƒ‰

<pre><code>
gcloud dataflow flex-template build gs://dev-karasuit-dataflow/templates/etl_template.json \
 --image "asia-northeast1-docker.pkg.dev/[ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ ID]/dev-karasuit-create-template/etl-image:v1" \
 --sdk-language "PYTHON" \
 --metadata-file "metadata.json"
</code></pre>

# â‘£ DAG ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

<pre><code>
gsutil cp etl_and_datamart_pipeline.py gs://<composer-bucket>/dags/
</code></pre>

# â‘¤ AirFlow ã‹ã‚‰ DAG ã‚’æ‰‹å‹•å®Ÿè¡Œ(æœ¬æ¥ã§ã‚ã‚Œã° AM09:00 ã«è‡ªå‹•èµ·å‹•)

![AirFlowUIå›³](img/Airflow.png)

# â‘¥ Slack ã‚ˆã‚Šãƒ¬ãƒãƒ¼ãƒˆã® URL ã‚’é€£æº

![Slacké€šçŸ¥å›³](img/Slack.png)

![ãƒ¬ãƒãƒ¼ãƒˆå†…å®¹ç”»é¢](img/Report.png)

## âš ï¸ æ³¨æ„äº‹é …

- `dev/locals.tf` ç­‰ã«è¨˜è¼‰ã•ã‚Œã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ ID ãªã©ã®æ©Ÿå¯†æƒ…å ±ã¯ `.gitignore` ã«è¿½åŠ ã—ã¦ãã ã•ã„
- ServiceAccount ã® key ãƒ•ã‚¡ã‚¤ãƒ«ã¯å…¬é–‹ã›ãšã€Secret Manager ç­‰ã§ç®¡ç†ã—ã¦ãã ã•ã„
- Slack Webhook ã® URL ã¯å¤–éƒ¨ã«æ¼ã‚Œãªã„ã‚ˆã†ã«ç’°å¢ƒå¤‰æ•°ã¾ãŸã¯ Secret Manager çµŒç”±ã§å‚ç…§ã—ã¦ãã ã•ã„
- Looker Studio ã® ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯äºˆã‚ä½œæˆã—ã¦ãŠã„ã¦ãã ã•ã„

---

## ğŸ“Œ å‚™è€ƒ

ã“ã®æ§‹æˆã¯ã€ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ã‚„ãƒ‡ãƒ¼ã‚¿åˆ†æåŸºç›¤æ§‹ç¯‰ã®å®Ÿå‹™ã«ãŠã„ã¦é »å‡ºã®æ§‹æˆã§ã™ã€‚  
æ¥­å‹™è‡ªå‹•åŒ–ãƒ»ãƒ¬ãƒãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ»é€šçŸ¥ã¾ã§ã‚’å«ã‚€ä¸€é€£ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®ç†è§£ãƒ»å®Ÿè·µã«å½¹ç«‹ã¡ã¾ã™ã€‚

---
